version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Set Node.js version for consistency
        - nvm use 18
        # Configure npm cache location
        - npm config set cache .npm
        # Clear npm cache to avoid issues
        - npm cache clean --force
        # Try npm ci first, fallback to npm install if lock file is out of sync
        - |
          if npm ci --prefer-offline --no-audit --progress=false; then
            echo "npm ci succeeded"
          else
            echo "npm ci failed, trying npm install instead"
            rm -f package-lock.json
            npm install --prefer-offline --no-audit --progress=false
          fi
        # Set up environment variables fallback
        - |
          if [ -z "$NODE_ENV" ]; then
            export NODE_ENV=production
          fi
    build:
      commands:
        # Type check before building
        - npm run type-check
        # Build the application
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - '.npm/**/*'
      - 'node_modules/**/*'
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin' 